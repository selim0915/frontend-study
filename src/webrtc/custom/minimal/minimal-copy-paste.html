<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="/src/webrtc/js/common/set-title.js"></script>
  <link rel="stylesheet" href="../../css/main.css">
</head>
<body>
  <h2>Minimal WebRTC í…ŒìŠ¤íŠ¸</h2>

  <!-- UI/UX ê¸°ë³¸ ìš”ì†Œ -->
  <div>
    <div class="row">
      <div class="col">
        <h3>Local</h3>
        <video id="localVideo" autoplay playsinline muted></video>
      </div>
      <div class="col">
        <h3>Remote</h3>
        <video id="remoteVideo" autoplay playsinline></video>
      </div>
    </div>

    <div class="row">
      <button id="startCallBtn">í†µí™” ì—°ê²°</button>
      <button id="endCallBtn">í†µí™” ì¢…ë£Œ</button>
      <button id="toggleCameraBtn">ì¹´ë©”ë¼ On/Off</button>
      <button id="toggleAudioBtn">ì˜¤ë””ì˜¤ On/Off</button>
    </div>
  </div>

  <!-- WebSocket signaling controls -->
  <div class="panel">
    <h3>Signaling(WebSocket) ì—°ê²°</h3>
    <p class="sub-text">
      - Aì™€ B ëª¨ë‘ í•˜ë‹¨ WS URL ì…ë ¥ë€ì´ wss://localhost:3001ì¸ì§€ í™•ì¸ í›„ â€œConnect WSâ€ í´ë¦­í•˜ì—¬ connected í™•ì¸<br/>
      - disconnectedì¸ ê²½ìš°, <a href="https://192.168.2.95:3001">https://192.168.2.95:3001</a> ì‹œê·¸ë„ë§ ì„œë²„ ì‹ ë¢°ëœ ì‚¬ì´íŠ¸ ì„¤ì •
      - Aì—ì„œ â€œCreate Offerâ€ í´ë¦­<br/>
      - Bì—ì„œ ìë™ìœ¼ë¡œ Answer ì‘ë‹µ, ICE í›„ë³´ ìë™ êµí™˜<br/>
    </p>

    <div class="row">
      <label>
        WS URL:
        <input id="wsUrl" type="text" style="width: 360px;" value="wss://192.168.2.95:3001" />
      </label>
      <button id="connectWs">ğŸ”Œ Connect WS</button>
      <button id="disconnectWs">âŒ Disconnect WS</button>
      <span id="wsStatus">disconnected</span>
    </div>
    <div class="row">
      <button class="createOffer" onclick="handleCreateOffer()">Create Offer</button>
    </div>
  </div>

  <!-- ìˆ˜ë™ WebRTC ì—°ê²° -->
  <div class="panel">
    <h3>ìˆ˜ë™ WebRTC ì—°ê²°</h3>
    <p class="sub-text">
      - Aì—ì„œ â€œCreate Offerâ€ í´ë¦­ â†’ Aì˜ SDPì— Offer í…ìŠ¤íŠ¸ ìƒì„±<br/>
      - Aì˜ SDP Offer í…ìŠ¤íŠ¸ë¥¼ Bì˜ SDPì— ë¶™ì—¬ë„£ê³  â€œCreate Answerâ€ í´ë¦­ â†’ Bì˜ SDPì— Answer í…ìŠ¤íŠ¸ ìƒì„±<br/>
      - Bì˜ SDP Answer í…ìŠ¤íŠ¸ë¥¼ Aì˜ SDPì— ë¶™ì—¬ë„£ê³  â€œSet Remote Answerâ€ í´ë¦­ â†’ Aì˜ ICE Candidatesì— í…ìŠ¤íŠ¸ ìƒì„±<br/>
      - Aì˜ ICE Candidates í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬ â†’ Bì˜ Remote ICE Candidatesì— ë¶™ì—¬ë„£ê³  â€œAdd Remote ICE Candidatesâ€ í´ë¦­<br/>
    </p>

    <div class="row">
      <button class="createOffer" onclick="handleCreateOffer()" title="RTCPeerConnectionì„ ë§Œë“¤ê³ , ë‚´ ì—°ê²° ì €ì¥ë¥¼ ë‹´ì€ Offer(SDP)ë¥¼ ìƒì„±í•´ ìƒëŒ€ì—ê²Œ ë³´ë‚´ê¸° ìœ„í•œ ì´ë²¤íŠ¸">Create Offer</button>
      <button id="createAnswer" title="ìƒëŒ€ê°€ ë³´ë‚¸ Offerë¥¼ ë°›ì•„ì„œ, ë‚´ê°€ ì—°ê²°í•  ì¤€ë¹„ê°€ ë˜ì—ˆë‹¤ëŠ” Answer(SDP)ë¥¼ ìƒì„±í•˜ëŠ” ì´ë²¤íŠ¸">Create Answer</button>
      <button id="setRemoteAnswer" title="ìƒëŒ€ê°€ ë³´ë‚¸ Answer(SDP)ë¥¼ ë‚´ RTCPeerConnectionì— ì ìš©í•˜ëŠ” ì´ë²¤íŠ¸">Set Remote Answer</button>
      <button id="addRemoteCandidates">Add Remote ICE Candidates</button>
    </div>

    <div class="row">
      <div class="col">
        <h4>SDP (Offer/Answer)</h4>
        <textarea id="sdpBox"></textarea>
      </div>
      <div class="col">
        <h4>ICE Candidates</h4>
        <textarea id="localCandidatesBox"></textarea>
      </div>
      <div class="col">
        <h4>Remote ICE Candidates</h4>
        <textarea id="remoteCandidatesBox"></textarea>
      </div>
    </div>
  </div>

  <script>
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    const startCallBtn = document.getElementById('startCallBtn');
    const endCallBtn = document.getElementById('endCallBtn');
    const toggleCameraBtn = document.getElementById('toggleCameraBtn');
    const toggleAudioBtn = document.getElementById('toggleAudioBtn');

    const createAnswerBtn = document.getElementById('createAnswer');
    const setRemoteAnswerBtn = document.getElementById('setRemoteAnswer');
    const addRemoteCandidatesBtn = document.getElementById('addRemoteCandidates');

    const sdpBox = document.getElementById('sdpBox');
    const localCandidatesBox = document.getElementById('localCandidatesBox');
    const remoteCandidatesBox = document.getElementById('remoteCandidatesBox');

    let pc;
    let localStream;
    let createOfferBtns;

    const configuration = {
      iceServers: []
    };

    // WebSocket signaling
    let connectWsBtn, disconnectWsBtn, wsStatusSpan, wsUrlInput;
    let ws = null;

    function setWsStatus(connected) {
      wsStatusSpan.textContent = connected ? 'connected' : 'disconnected';
      wsStatusSpan.style.color = connected ? 'green' : 'red';
    }

    /**
     * WebRTC ê´€ë ¨ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
     * @param {boolean} disable - trueì´ë©´ "Start Camera"ë¥¼ ì œì™¸í•œ ëª¨ë“  ë²„íŠ¼ì„ ë¹„í™œì„±í™”,
      *                           falseì´ë©´ ì¹´ë©”ë¼ê°€ ì¼œì§€ë©´ ëª¨ë“  ë²„íŠ¼ì„ í™œì„±í™”
     */
    function setButtonsDisabled(disabled) {
      connectWsBtn.disabled = disabled;
      disconnectWsBtn.disabled = disabled;
      createAnswerBtn.disabled = disabled;
      setRemoteAnswerBtn.disabled = disabled;
      addRemoteCandidatesBtn.disabled = disabled;
      if (createOfferBtns) {
        createOfferBtns.forEach(btn => btn.disabled = disabled);
      }
    }

    /**
     * í†µí™” ìƒíƒœ ê´€ë ¨ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
     */
    function updateCallButtons(inCall) {
      startCallBtn.disabled = inCall;
      endCallBtn.disabled = !inCall;
      toggleCameraBtn.disabled = !inCall;
      toggleAudioBtn.disabled = !inCall;
    }

    /**
     * WebSocket ì„œë²„ URL ìƒì„± í•¨ìˆ˜ (í•­ìƒ wss ì‚¬ìš©)
     */
    function buildWssUrl(raw) {
      console.log(raw)

      const input = (raw || '').trim();
      const pageIsHttps = location.protocol === 'https:';
      const defaultHostname = location.hostname;
      const defaultPort = 3001;

      if (!input) {
        return `wss://${defaultHostname}:${defaultPort}`;
      }

      return input;
    }

    async function preflightHttps(url) {
      if (!url) return false;
      try {
        await fetch(url, { mode: 'no-cors' });
        return true;
      } catch (_) {
        return false;
      }
    }

    // DOMì´ ì¤€ë¹„ëœ í›„ì— ìš”ì†Œ ì„ íƒ ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
    window.addEventListener('DOMContentLoaded', () => {
      connectWsBtn = document.getElementById('connectWs');
      disconnectWsBtn = document.getElementById('disconnectWs');
      wsStatusSpan = document.getElementById('wsStatus');
      wsUrlInput = document.getElementById('wsUrl');


      createOfferBtns = document.querySelectorAll('.createOffer');

      setButtonsDisabled(true); // í˜ì´ì§€ ë¡œë“œ ì‹œ Start Cameraë¥¼ ì œì™¸í•œ ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
      updateCallButtons(false);
    
      connectWsBtn.onclick = () => {
        if (ws && ws.readyState === WebSocket.OPEN) return;
        try {
          const targetUrl = buildWssUrl(wsUrlInput.value || '');
          const u = new URL(targetUrl);
          u.protocol = 'https:';

          const probeUrl = u.toString();
          preflightHttps(probeUrl).then((ok) => {
            if (!ok) {
              alert('ëª¨ë°”ì¼ì—ì„œ ì¸ì¦ì„œ ì‹ ë¢°ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì•„ë˜ ë§í¬ë¥¼ ì—´ì–´ ìŠ¹ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”:\n' + probeUrl);
              window.open(probeUrl, '_blank');
            }
          });
          ws = new WebSocket(targetUrl);
          ws.onopen = () => setWsStatus(true);
          ws.onclose = () => setWsStatus(false);
          ws.onerror = (e) => {
            setWsStatus(false);
            alert('WS ì—°ê²° ì˜¤ë¥˜. ì¸ì¦ì„œ ì‹ ë¢° ë˜ëŠ” ë„¤íŠ¸ì›Œí¬/ë°©í™”ë²½ì„ í™•ì¸í•˜ì„¸ìš”.');
          };
    
          ws.onmessage = async (msg) => {
            try {
              const data = JSON.parse(msg.data);
              ensurePC();
              if (data.type === 'offer') {
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                if (ws && ws.readyState === WebSocket.OPEN) {
                  ws.send(JSON.stringify({ type: 'answer', answer: pc.localDescription }));
                } else {
                  sdpBox.value = JSON.stringify(pc.localDescription);
                }
              }
              if (data.type === 'answer') {
                await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
              }
              if (data.type === 'candidate') {
                try {
                  await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (err) {
                  console.error('Error adding ICE candidate:', err);
                }
              }
            } catch (e) {
              console.error('WS message handling error:', e);
            }
          };
        } catch (e) {
          alert('WS ì—°ê²° ì‹¤íŒ¨: ' + e.message);
        }
      };
    
      disconnectWsBtn.onclick = () => {
        if (ws) {
          try { ws.close(); } catch {}
          ws = null;
          setWsStatus(false);
        }
      };
    });

    function ensurePC() {
      if (!pc) {
        pc = new RTCPeerConnection(configuration);

        const remoteStream = new MediaStream();
        remoteVideo.srcObject = remoteStream;
        pc.ontrack = (event) => {
          event.streams[0].getTracks().forEach((t) => remoteStream.addTrack(t));
        };

        // ë¡œì»¬ ICE í›„ë³´: ìˆ˜ë™ í…ìŠ¤íŠ¸ + WS ì „ì†¡ ë³‘í–‰
        pc.onicecandidate = (event) => {
          if (event.candidate) {
            // ìˆ˜ë™ êµí™˜ì„ ìœ„í•œ í…ìŠ¤íŠ¸ ëˆ„ì 
            localCandidatesBox.value += JSON.stringify(event.candidate) + '\n';
            // WS ì—°ê²° ì‹œ ìë™ ì „ì†¡
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({ type: 'candidate', candidate: event.candidate }));
            }
          }
        };

        pc.oniceconnectionstatechange = () => {
          console.log('ICE state:', pc.iceConnectionState);
        };
      }
    }

    /**
     * í†µí™” ì—°ê²° í•¨ìˆ˜
     */
    async function startCall() {
      try {
        // ê¶Œí•œ í™•ì¸
        const cameraStatus = await navigator.permissions.query({ name: 'camera' });
        const microphoneStatus = await navigator.permissions.query({ name: 'microphone' });
        if (cameraStatus.state === 'denied') { alert('ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }
        if (microphoneStatus.state === 'denied') { alert('ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }

        // ë¯¸ë””ì–´ ì¥ì¹˜ ì—°ê²°
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        // WebRTC ì—°ê²°
        ensurePC();
        localStream.getTracks().forEach((track) => pc.addTrack(track, localStream));

        // UX ë²„íŠ¼ ìƒíƒœ ì„¤ì •
        setButtonsDisabled(false);
        updateCallButtons(true);
      } catch (e) {
        alert('Error startCamera\n' + e.message);
      }
    }
    
    // í†µí™” ì¢…ë£Œ
    function endCall() {
      if (pc) {
        pc.close();
        pc = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      localVideo.srcObject = null;
      remoteVideo.srcObject = null;

      // UI ì´ˆê¸°í™”
      sdpBox.value = '';
      localCandidatesBox.value = '';
      remoteCandidatesBox.value = '';
      setButtonsDisabled(true);
      updateCallButtons(false);
    }

    // ì¹´ë©”ë¼ On/Off
    function toggleCamera() {
      if (localStream) {
        const videoTrack = localStream.getVideoTracks()[0];
        if (videoTrack) {
          videoTrack.enabled = !videoTrack.enabled;
        }
      }
    }

    // ì˜¤ë””ì˜¤ On/Off
    function toggleAudio() {
      if (localStream) {
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
          audioTrack.enabled = !audioTrack.enabled;
        }
      }
    }

    startCallBtn.onclick = startCall;
    endCallBtn.onclick = endCall;
    toggleCameraBtn.onclick = toggleCamera;
    toggleAudioBtn.onclick = toggleAudio;

    // Offer ìƒì„±: ìˆ˜ë™/WS ë³‘í–‰
    async function handleCreateOffer() {
      try {
        ensurePC();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
    
        // í•­ìƒ í…ìŠ¤íŠ¸ ë°•ìŠ¤ì— ì±„ìš°ê¸°
        sdpBox.value = JSON.stringify(pc.localDescription);
    
        // WS ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ì¶”ê°€ë¡œ ì „ì†¡
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'offer', offer: pc.localDescription }));
        }
      } catch (e) {
        alert('Offer ìƒì„± ì‹¤íŒ¨: ' + e.message);
      }
    };

    // Answer ìƒì„±: ìˆ˜ë™/WS ë³‘í–‰
    createAnswerBtn.onclick = async () => {
      try {
        ensurePC();
        const remoteOffer = JSON.parse(sdpBox.value.trim());
        await pc.setRemoteDescription(new RTCSessionDescription(remoteOffer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
    
        // í•­ìƒ í…ìŠ¤íŠ¸ ë°•ìŠ¤ì— ì±„ìš°ê¸°
        sdpBox.value = JSON.stringify(pc.localDescription);
    
        // WS ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ì¶”ê°€ë¡œ ì „ì†¡
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'answer', answer: pc.localDescription }));
        }
      } catch (e) {
        alert('Answer ìƒì„± ì‹¤íŒ¨: ' + e.message);
      }
    };

    // Remote Answer ìˆ˜ë™ ì ìš©
    setRemoteAnswerBtn.onclick = async () => {
      try {
        const remoteAnswer = JSON.parse(sdpBox.value.trim());
        await pc.setRemoteDescription(new RTCSessionDescription(remoteAnswer));
        alert('Remote Answer ì ìš© ì™„ë£Œ!');
      } catch (e) {
        alert('Remote Answer ì ìš© ì‹¤íŒ¨: ' + e.message);
      }
    };

    // Remote ICE candidates ìˆ˜ë™ ì ìš©
    addRemoteCandidatesBtn.onclick = async () => {
      try {
        const lines = remoteCandidatesBox.value
          .split('\n')
          .map((l) => l.trim())
          .filter((l) => !!l);

        for (const line of lines) {
          const candidateObj = JSON.parse(line);
          await pc.addIceCandidate(new RTCIceCandidate(candidateObj));
        }
        alert('Remote ICE candidates ì ìš© ì™„ë£Œ!');
      } catch (e) {
        alert('ICE candidates ì ìš© ì‹¤íŒ¨: ' + e.message);
      }
    };
  </script>
</body>
</html>
